using SendGrid;
using SendGrid.Helpers.Mail;
using StudentApi.Helpers;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace StudentApi.SendGrid
{
    public class SendGridSender : IDisposable
    {
        private SendGridClient client;

        public SendGridSender(string apiKey)
        {
            client = new SendGridClient(apiKey);
        }


        public async Task<OperationResult> SendEmail_ResetUserPassword(string email, string name, string surname, string newPassword)
        {
            OperationResult result = new OperationResult();
            var from = new EmailAddress("no-reply@sanstudent.pl", "SanStudent");
            var subject = "Resetowanie hasła w serwisie SanStudent";
            var to = new EmailAddress(email, $"{name} {surname}");
            var plainTextContent = $"Oto twoje nowe hasło do serwisu SanStudent: {newPassword}";
            var htmlContent = ResetPasswordHtml(name, newPassword);
            var msg = MailHelper.CreateSingleEmail(from, to, subject, plainTextContent, htmlContent);
            try
            {
                var response = await client.SendEmailAsync(msg);
                if ((int)response.StatusCode >= 200 && (int)response.StatusCode < 300)
                {
                    result.Result = true;
                    result.Content = $"Wiadomość email z nowym hasłem została wysłana na adres: {email}";
                    result.Error = null;
                    return result;
                }
                else
                {
                    result.Result = false;
                    result.Content = null;
                    result.Error = "Wystąpił problem z serwisem autoryzacji. Proszę o kontakt z administratorem serwisu";
                    return result;
                }
            }
            catch (Exception ex)
            {
                result.Result = false;
                result.Content = null;
                result.Error = ex.ToString();
                return result;
            }

        }


        private string ResetPasswordHtml(string firstName, string newPassword)
        {
            StringBuilder sb = new StringBuilder();
            sb.Append("<html xmlns='http://www.w3.org/1999/xhtml' xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:v='urn:schemas-microsoft-com:vml'><head><meta content='text/html; charset=utf-8' http-equiv='Content-Type'/><meta content='width=device-width' name='viewport'/><meta content='IE=edge' http-equiv='X-UA-Compatible'/><title></title><link href='https://fonts.googleapis.com/css?family=Bitter' rel='stylesheet' type='text/css'/><link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'/><link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'/><style type='text/css'>body{margin: 0;padding: 0;}table,std,tr{vertical-align: top;border-collapse: collapse;}*{line-height: inherit;}a[x-apple-data-detectors=true]{color: inherit !important;text-decoration: none !important;}</style><style id='media-query' type='text/css'>@media (max-width: 625px){.block-grid,.col{min-width: 320px !important;max-width: 100% !important;display: block !important;}.block-grid{width: 100% !important;}.col{width: 100% !important;}.col>div{margin: 0 auto;}img.fullwidth,img.fullwidthOnMobile{max-width: 100% !important;}.no-stack .col{min-width: 0 !important;display: table-cell !important;}.no-stack.two-up .col{width: 50% !important;}.no-stack .col.num4{width: 33% !important;}.no-stack .col.num8{width: 66% !important;}.no-stack .col.num4{width: 33% !important;}.no-stack .col.num3{width: 25% !important;}.no-stack .col.num6{width: 50% !important;}.no-stack .col.num9{width: 75% !important;}.video-block{max-width: none !important;}.mobile_hide{min-height: 0px;max-height: 0px;max-width: 0px;display: none;overflow: hidden;font-size: 0px;}.desktop_hide{display: block !important;max-height: none !important;}}</style></head><body class='clean-body' style='margin: 0; padding: 0; -webkit-text-size-adjust: 100%; background-color: #FFFFFF;'><table bgcolor='#FFFFFF' cellpadding='0' cellspacing='0' class='nl-container' role='presentation' style='table-layout: fixed; vertical-align: top; min-width: 320px; Margin: 0 auto; border-spacing: 0; border-collapse: collapse; mso-table-lspace: 0pt; mso-table-rspace: 0pt; background-color: #FFFFFF; width: 100%;' valign='top' width='100%'><tbody><tr style='vertical-align: top;' valign='top'><td style='word-break: break-word; vertical-align: top;' valign='top'><div style='background-color:#3f51b5;'><div class='block-grid' style='Margin: 0 auto; min-width: 320px; max-width: 605px; overflow-wrap: break-word; word-wrap: break-word; word-break: break-word; background-color: transparent;'><div style='border-collapse: collapse;display: table;width: 100%;background-color:transparent;'><div class='col num12' style='min-width: 320px; max-width: 605px; display: table-cell; vertical-align: top; width: 605px;'><div style='width:100% !important;'><div style='border-top:0px solid transparent; border-left:0px solid transparent; border-bottom:0px solid transparent; border-right:0px solid transparent; padding-top:0px; padding-bottom:0px; padding-right: 0px; padding-left: 0px;'><table border='0' cellpadding='0' cellspacing='0' class='divider' role='presentation' style='table-layout: fixed; vertical-align: top; border-spacing: 0; border-collapse: collapse; mso-table-lspace: 0pt; mso-table-rspace: 0pt; min-width: 100%; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%;' valign='top' width='100%'><tbody><tr style='vertical-align: top;' valign='top'><td class='divider_inner' style='word-break: break-word; vertical-align: top; min-width: 100%; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%; padding-top: 20px; padding-right: 20px; padding-bottom: 20px; padding-left: 20px;' valign='top'><table align='center' border='0' cellpadding='0' cellspacing='0' class='divider_content' role='presentation' style='table-layout: fixed; vertical-align: top; border-spacing: 0; border-collapse: collapse; mso-table-lspace: 0pt; mso-table-rspace: 0pt; border-top: 0px solid transparent; width: 100%;' valign='top' width='100%'><tbody><tr style='vertical-align: top;' valign='top'><td style='word-break: break-word; vertical-align: top; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%;' valign='top'><span></span></td></tr></tbody></table></td></tr></tbody></table><div style='color:#FFFFFF;font-family:'Roboto', Tahoma, Verdana, Segoe, sans-serif;line-height:1.2;padding-top:20px;padding-right:10px;padding-bottom:10px;padding-left:10px;'><div style='font-size: 12px; line-height: 1.2; font-family: 'Roboto', Tahoma, Verdana, Segoe, sans-serif; color: #FFFFFF; mso-line-height-alt: 14px;'><p style='font-size: 28px; line-height: 1.2; text-align: center; word-break: break-word; font-family: Roboto, Tahoma, Verdana, Segoe, sans-serif; mso-line-height-alt: 34px; margin: 0; color: #fff'><span style='font-size: 28px; color: #fff''>SanStudent</span></p></div></div><div style='color:#acd6f4;font-family:'Roboto', Tahoma, Verdana, Segoe, sans-serif;line-height:1.5;padding-top:10px;padding-right:10px;padding-bottom:10px;padding-left:10px;'><div style='font-size: 12px; line-height: 1.5; font-family: 'Roboto', Tahoma, Verdana, Segoe, sans-serif; color: #acd6f4; mso-line-height-alt: 18px;'><p style='font-size: 14px; line-height: 1.5; text-align: center; word-break: break-word; font-family: Roboto, Tahoma, Verdana, Segoe, sans-serif; mso-line-height-alt: 21px; margin-top: 10px; color: #fff'>Twoje nowe hasło do serwisu <span style='text-decoration: none; color: #fff'>SanStudent</span> to:</p></div></div><div style='color:#FFFFFF;font-family:'Roboto', Tahoma, Verdana, Segoe, sans-serif;line-height:1.2;padding-top:20px;padding-right:10px;padding-bottom:10px;padding-left:10px;'><div style='font-size: 12px; line-height: 1.2; font-family: 'Roboto', Tahoma, Verdana, Segoe, sans-serif; color: #FFFFFF; mso-line-height-alt: 14px;'><p style='font-size: 38px; line-height: 1.2; text-align: center; word-break: break-word; font-family: Roboto, Tahoma, Verdana, Segoe, sans-serif; mso-line-height-alt: 46px; margin: 0;'><span style='font-size: 38px; color: #fff;'>");
            sb.Append($"{newPassword}");
            sb.Append("</span></p></div></div><table border='0' cellpadding='0' cellspacing='0' class='divider' role='presentation' style='table-layout: fixed; vertical-align: top; border-spacing: 0; border-collapse: collapse; mso-table-lspace: 0pt; mso-table-rspace: 0pt; min-width: 100%; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%;' valign='top' width='100%'><tbody><tr style='vertical-align: top;' valign='top'><td class='divider_inner' style='word-break: break-word; vertical-align: top; min-width: 100%; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%; padding-top: 20px; padding-right: 20px; padding-bottom: 20px; padding-left: 20px;' valign='top'><table align='center' border='0' cellpadding='0' cellspacing='0' class='divider_content' role='presentation' style='table-layout: fixed; vertical-align: top; border-spacing: 0; border-collapse: collapse; mso-table-lspace: 0pt; mso-table-rspace: 0pt; border-top: 0px solid transparent; width: 100%;' valign='top' width='100%'><tbody><tr style='vertical-align: top;' valign='top'><td style='word-break: break-word; vertical-align: top; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%;' valign='top'><span></span></td></tr></tbody></table></td></tr></tbody></table></div></div></div></div></div></div><div style='background-color:#f3f3f3;'><div class='block-grid' style='Margin: 0 auto; min-width: 320px; max-width: 605px; overflow-wrap: break-word; word-wrap: break-word; word-break: break-word; background-color: transparent;'><div style='border-collapse: collapse;display: table;width: 100%;background-color:transparent;'><div class='col num12' style='min-width: 320px; max-width: 605px; display: table-cell; vertical-align: top; width: 605px;'><div style='width:100% !important;'><div style='border-top:0px solid transparent; border-left:0px solid transparent; border-bottom:0px solid transparent; border-right:0px solid transparent; padding-top:0px; padding-bottom:0px; padding-right: 0px; padding-left: 0px;'><table border='0' cellpadding='0' cellspacing='0' class='divider' role='presentation' style='table-layout: fixed; vertical-align: top; border-spacing: 0; border-collapse: collapse; mso-table-lspace: 0pt; mso-table-rspace: 0pt; min-width: 100%; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%;' valign='top' width='100%'><tbody><tr style='vertical-align: top;' valign='top'><td class='divider_inner' style='word-break: break-word; vertical-align: top; min-width: 100%; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%; padding-top: 25px; padding-right: 25px; padding-bottom: 25px; padding-left: 25px;' valign='top'><table align='center' border='0' cellpadding='0' cellspacing='0' class='divider_content' role='presentation' style='table-layout: fixed; vertical-align: top; border-spacing: 0; border-collapse: collapse; mso-table-lspace: 0pt; mso-table-rspace: 0pt; border-top: 0px solid transparent; width: 100%;' valign='top' width='100%'><tbody><tr style='vertical-align: top;' valign='top'><td style='word-break: break-word; vertical-align: top; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%;' valign='top'><span></span></td></tr></tbody></table></td></tr></tbody></table></div></div></div></div></div></div><div style='background-color:#f3f3f3;'><div class='block-grid' style='Margin: 0 auto; min-width: 320px; max-width: 605px; overflow-wrap: break-word; word-wrap: break-word; word-break: break-word; background-color: transparent;'><div style='border-collapse: collapse;display: table;width: 100%;background-color:transparent;'><div class='col num12' style='min-width: 320px; max-width: 605px; display: table-cell; vertical-align: top; width: 605px;'><div style='width:100% !important;'><div style='border-top:0px solid transparent; border-left:0px solid transparent; border-bottom:0px solid transparent; border-right:0px solid transparent; padding-top:5px; padding-bottom:5px; padding-right: 0px; padding-left: 0px;'><div style='color:#3f51b5;font-family:'Roboto', Tahoma, Verdana, Segoe, sans-serif;line-height:1.2;padding-top:10px;padding-right:10px;padding-bottom:10px;padding-left:10px;'><div style='font-size: 12px; line-height: 1.2; font-family: 'Roboto', Tahoma, Verdana, Segoe, sans-serif; color: #3f51b5; mso-line-height-alt: 14px;'><p style='font-size: 14px; line-height: 1.2; word-break: break-word; font-family: Roboto, Tahoma, Verdana, Segoe, sans-serif; mso-line-height-alt: 17px; margin: 0;'><strong><span style='font-size: 24px !important; color: #3f51b5;'>Witaj");
            sb.Append($" {firstName}");
            sb.Append(",</span></strong></p></div></div><div style='color:#555555;font-family:Open Sans, Helvetica Neue, Helvetica, Arial, sans-serif;line-height:1.5;padding-top:10px;padding-right:10px;padding-bottom:10px;padding-left:10px;'><div style='font-size: 12px; line-height: 1.5; color: #555555; font-family: Open Sans, Helvetica Neue, Helvetica, Arial, sans-serif; mso-line-height-alt: 18px;'><p style='font-size: 14px; line-height: 1.5; word-break: break-word; text-align: justify; mso-line-height-alt: 21px; margin: 0;'>Poprosiłeś/aś o reset hasła w serwisie SanStudent. Powyżej widzisz swoje nowe hasło. Twoje poprzednie hasło zostało usunięte. Teraz możesz się zalogować do serwisu używając nowego hasła.</p><p style='font-size: 14px; line-height: 1.5; word-break: break-word; text-align: justify; mso-line-height-alt: 21px; margin: 0;'> </p><p style='font-size: 14px; line-height: 1.5; word-break: break-word; text-align: right; mso-line-height-alt: 21px; margin: 0;'>Pozdrawiam, Andrzej Herman</p></div></div><table border='0' cellpadding='0' cellspacing='0' class='divider' role='presentation' style='table-layout: fixed; vertical-align: top; border-spacing: 0; border-collapse: collapse; mso-table-lspace: 0pt; mso-table-rspace: 0pt; min-width: 100%; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%;' valign='top' width='100%'><tbody><tr style='vertical-align: top;' valign='top'><td class='divider_inner' style='word-break: break-word; vertical-align: top; min-width: 100%; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%; padding-top: 25px; padding-right: 25px; padding-bottom: 25px; padding-left: 25px;' valign='top'><table align='center' border='0' cellpadding='0' cellspacing='0' class='divider_content' role='presentation' style='table-layout: fixed; vertical-align: top; border-spacing: 0; border-collapse: collapse; mso-table-lspace: 0pt; mso-table-rspace: 0pt; border-top: 0px solid transparent; width: 100%;' valign='top' width='100%'><tbody><tr style='vertical-align: top;' valign='top'><td style='word-break: break-word; vertical-align: top; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%;' valign='top'><span></span></td></tr></tbody></table></td></tr></tbody></table></div></div></div></div></div></div><div style='background-color:transparent;'><div class='block-grid mixed-two-up' style='Margin: 0 auto; min-width: 320px; max-width: 605px; overflow-wrap: break-word; word-wrap: break-word; word-break: break-word; background-color: transparent;'><div style='border-collapse: collapse;display: table;width: 100%;background-color:transparent;'><div class='col num8' style='display: table-cell; vertical-align: top; min-width: 320px; max-width: 400px; width: 403px;'><div style='width:100% !important;'><div style='border-top:0px solid transparent; border-left:0px solid transparent; border-bottom:0px solid transparent; border-right:0px solid transparent; padding-top:15px; padding-bottom:15px; padding-right: 0px; padding-left: 0px;'><div style='color:#8F8F8F;font-family:Open Sans, Helvetica Neue, Helvetica, Arial, sans-serif;line-height:1.2;padding-top:10px;padding-right:10px;padding-bottom:10px;padding-left:10px;'><div style='font-size: 12px; line-height: 1.2; color: #8F8F8F; font-family: Open Sans, Helvetica Neue, Helvetica, Arial, sans-serif; mso-line-height-alt: 14px;'><p style='font-size: 11px; line-height: 1.2; word-break: break-word; mso-line-height-alt: 13px; margin: 0;'><span style='font-size: 11px;'>Copyright © 2020 SanStudent, Wszelkie prawa zastrzeżone. </span><br/><span style='font-size: 11px;'>Email wysłany automatycznie z serwisu SanStudent.</span></p><p style='font-size: 14px; line-height: 1.2; word-break: break-word; mso-line-height-alt: 17px; margin: 0;'>Proszę na niego nie odpowiadać.</p></div></div></div></div></div><div class='col num4' style='display: table-cell; vertical-align: top; max-width: 320px; min-width: 200px; width: 201px;'><div style='width:100% !important;'><div style='border-top:0px solid transparent; border-left:0px solid transparent; border-bottom:0px solid transparent; border-right:0px solid transparent; padding-top:15px; padding-bottom:15px; padding-right: 10px; padding-left: 10px;'><div></div></div></div></div></div></div></div></td></tr></tbody></table></body></html>");
            return sb.ToString();
        }


        public void Dispose()
        {
            client = null;
        }
    }
}
